<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <title>New Dubai International Airport - DATABASE</title>
  <style>
    :root {
      --primary-color: #00d2ff;
      --background-dark: #101c2c;
      --background-darker: #0f141a;
      --background-light: #1b1f24;
      --background-lighter: #1e2a38;
      --text-color-light: #eee;
      --text-color-muted: #8ab4f8;
      --danger-color: #ff4e50;
      --danger-color-hover: #e43e3e;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      --border-radius: 6px;
      --max-width-table-cell: 300px;
      --max-width-logo-cell: 70px;
      --transition-speed: 0.3s;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: var(--text-color-light);
      margin: 0;
      padding: 0;
      font-size: 14px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    h1 {
      text-align: center;
      font-size: 32px;
      color: var(--primary-color);
      padding: 20px 10px 10px;
      margin: 0;
      user-select: none;
    }

    .tabs {
      display: flex;
      background: var(--background-dark);
      flex-wrap: wrap;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      user-select: none;
    }

    .tab {
      flex: 1;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      color: var(--text-color-muted);
      background: var(--background-dark);
      border-bottom: 2px solid transparent;
      transition: background var(--transition-speed), border-bottom var(--transition-speed),
        color var(--transition-speed);
      font-weight: 600;
    }

    .tab:hover,
    .tab:focus-visible {
      background: #1b2d42;
      outline: none;
      color: #a3c9ff;
    }

    .tab.active {
      color: var(--text-color-light);
      border-bottom: 2px solid var(--primary-color);
      background: #172a3a;
      font-weight: 700;
    }

    .tab-content {
      display: none;
      padding: 20px;
      animation: fadeIn 0.4s ease;
      flex-grow: 1;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
      color: var(--primary-color);
    }

    input,
    button,
    textarea,
    select {
      padding: 10px;
      margin: 5px 0 10px;
      width: 100%;
      border-radius: var(--border-radius);
      border: 1px solid #444;
      background-color: var(--background-lighter);
      color: var(--text-color-light);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 6px var(--primary-color);
    }

    input.invalid,
    select.invalid,
    textarea.invalid {
      border-color: var(--danger-color);
      box-shadow: 0 0 6px var(--danger-color);
    }

    .error-message {
      font-size: 0.85rem;
      color: var(--danger-color);
      margin-top: -8px;
      margin-bottom: 10px;
      display: none;
    }

    button {
      background: linear-gradient(to right, #00d2ff, #3a7bd5);
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.3s ease;
      user-select: none;
    }

    button:hover {
      transform: scale(1.02);
      background: linear-gradient(to right, #3a7bd5, #00d2ff);
      outline: none;
    }

    button:focus-visible {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
    }

    button:disabled {
      cursor: not-allowed;
      opacity: 0.5;
      transform: none;
      background: var(--background-darker);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      border: 1px solid #333;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      table-layout: fixed;
      word-wrap: break-word;
    }

    th,
    td {
      padding: 8px 10px;
      border: 1px solid #2a2a2a;
      text-align: left;
      background: var(--background-light);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: var(--max-width-table-cell);
      vertical-align: middle;
    }

    th {
      background: var(--background-darker);
      text-transform: uppercase;
      font-weight: bold;
      color: var(--primary-color);
      user-select: none;
    }

    .remove-btn {
      background: var(--danger-color);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s ease;
      user-select: none;
      font-weight: 600;
    }

    .remove-btn:hover,
    .remove-btn:focus-visible {
      background: var(--danger-color-hover);
      outline: none;
    }

    .remove-btn:focus-visible {
      outline: 2px solid var(--danger-color-hover);
      outline-offset: 2px;
    }

    img.logo {
      height: 30px;
      vertical-align: middle;
      margin-right: 8px;
    }

    td.logo-cell {
      background-color: #fff;
      padding: 5px;
      border-radius: 4px;
      text-align: center;
      width: var(--max-width-logo-cell);
      min-width: var(--max-width-logo-cell);
      max-width: var(--max-width-logo-cell);
    }

    td.logo-cell img {
      width: 60px;
      max-height: 40px;
      object-fit: contain;
    }

    .status-cell {
      transition: all 0.3s ease;
      position: relative;
      cursor: pointer;
    }

    .status-cell:hover {
      background-color: var(--background-lighter) !important;
    }

    .status-cell[data-status="Landing"],
    .status-cell[data-status="Taking Off"] {
      animation: pulse 2s infinite;
    }

    .status-cell[data-status="Boarding Now"] {
      animation: blink 1.5s infinite;
    }

    .status-cell[data-status="Delayed"] {
      color: #ff9800;
    }

    .status-cell[data-status="Cancelled"] {
      color: #f44336;
    }

    .status-cell[data-status="Finished"] {
      color: #9e9e9e;
      font-style: italic;
    }

    .status-cell {
      position: relative;
      padding: 8px !important;
    }

    .status-text {
      display: block;
      font-weight: 500;
    }

    .confirmed-time {
      display: block;
      font-size: 0.85em;
      color: #666;
      margin-top: 2px;
    }

    /* Status colors */
    .status-cell[data-status="Confirmed"] .status-text {
      color: #4CAF50;
    }

    .status-cell[data-status="Delayed"] .confirmed-time {
      color: #ff9800;
    }

    .status-cell[data-status="Cancelled"] .confirmed-time {
      color: #f44336;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Modal improvements */
    #confirmModal {
      animation: fadeIn 0.2s ease;
    }

    #confirmModalContent {
      animation: slideIn 0.3s ease;
    }

    .button-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      padding: 15px;
    }

    .button-container button {
      min-width: 140px;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .button-container button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .button-container button:active {
      transform: translateY(0);
    }

    .button-container .close-button {
      background: #757575;
      margin-top: 10px;
      width: 100%;
    }

    #confirmModalContent {
      max-width: 500px;
      width: 90%;
      background: white;
      border-radius: 8px;
      padding: 20px;
      position: relative;
    }

    #modalDesc {
      text-align: center;
      margin-bottom: 15px;
      padding: 10px;
      border-bottom: 1px solid #eee;
      font-weight: 500;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {

      h1 {
        font-size: 24px;
      }

      label {
        margin-top: 10px;
      }

      .tabs {
        font-size: 0.9rem;
      }

      th,
      td {
        white-space: normal;
        max-width: 150px;
        font-size: 0.85rem;
        padding: 6px 8px;
      }

      td.logo-cell {
        width: 50px;
        min-width: 50px;
        max-width: 50px;
      }

      td.logo-cell img {
        width: 45px;
        max-height: 30px;
      }
    }

    textarea#output {
      height: 150px;
      resize: vertical;
      font-family: monospace;
      background-color: var(--background-lighter);
      color: var(--text-color-light);
    }

    .loading-indicator {
      display: none;
      font-size: 0.9rem;
      color: var(--primary-color);
      margin-top: 10px;
    }

    /* Piscar vermelho e verde */
    .red-piscante {
      animation: blink-red 1s infinite;
      background-color: rgba(255, 0, 0, 0.3);
    }

    .green-piscante {
      animation: blink-green 1s infinite;
      background-color: rgba(0, 255, 0, 0.3);
    }

    @keyframes blink-red {
      0%,
      100% {
        background-color: transparent;
      }

      50% {
        background-color: rgba(255, 0, 0, 0.6);
      }
    }

    @keyframes blink-green {
      0%,
      100% {
        background-color: transparent;
      }

      50% {
        background-color: rgba(0, 255, 0, 0.6);
      }
    }

    /* Modal de confirmação */
    #confirmModal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }

    #confirmModalContent {
      background-color: var(--background-lighter);
      margin: 5% auto;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 500px;
      color: var(--text-color-light);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      user-select: none;
      text-align: center;
      animation: slideIn 0.3s ease;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .modal-title {
      font-size: 1.5em;
      margin: 0 0 20px;
      color: var(--primary-color);
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .button-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      padding: 10px 0;
    }

    .button-container button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      min-width: 140px;
      opacity: 0.9;
    }

    .button-container button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      opacity: 1;
    }

    .button-container button:active {
      transform: translateY(0);
    }

    .button-container .close-button {
      grid-column: 1 / -1;
      background: #757575;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      #confirmModalContent {
        margin: 10% auto;
        padding: 20px;
        width: 95%;
      }

      .button-container {
        grid-template-columns: 1fr;
      }

      .button-container button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <h1 tabindex="0">New Dubai International Airport <span id="clock" style="font-size: 0.8em; color: var(--primary-color);"></span></h1>

  <nav class="tabs" role="tablist" aria-label="Navegação das abas">
    <button role="tab" aria-selected="true" aria-controls="aba-chegadas" id="tab-chegadas" class="tab active" onclick="trocarAba(0)"
      onkeyup="handleKey(event, 0)">🛬 Chegadas</button>
    <button role="tab" aria-selected="false" aria-controls="aba-partidas" id="tab-partidas" class="tab" onclick="trocarAba(1)"
      onkeyup="handleKey(event, 1)">🛫 Partidas</button>
    <button role="tab" aria-selected="false" aria-controls="aba-novo" id="tab-novo" class="tab" onclick="trocarAba(2)"
      onkeyup="handleKey(event, 2)">➕ Novo Voo</button>
    <button role="tab" aria-selected="false" aria-controls="aba-backup" id="tab-backup" class="tab" onclick="trocarAba(3)"
      onkeyup="handleKey(event, 3)">💾 Backup</button>
  </nav>

  <main>
    <section class="tab-content active" id="aba-chegadas" role="tabpanel" aria-labelledby="tab-chegadas" tabindex="0">
      <label for="filter-companhia">Filtrar por Companhia Aérea:</label>
      <select id="filter-companhia" aria-label="Filtrar por Companhia Aérea" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>

      <label for="filter-destino">Filtrar por Destino:</label>
      <select id="filter-destino" aria-label="Filtrar por Destino" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>

      <label for="filter-pais">Filtrar por País:</label>
      <select id="filter-pais" aria-label="Filtrar por País" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>

      <label for="filter-tps">Filtrar por TPS:</label>
      <select id="filter-tps" aria-label="Filtrar por TPS" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>
      <div id="chegadasTabela" aria-live="polite" aria-relevant="all"></div>
    </section>

    <section class="tab-content" id="aba-partidas" role="tabpanel" aria-labelledby="tab-partidas" tabindex="0">
      <label for="filter-companhia-partidas">Filtrar por Companhia Aérea:</label>
      <select id="filter-companhia-partidas" aria-label="Filtrar por Companhia Aérea" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>

      <label for="filter-destino-partidas">Filtrar por Destino:</label>
      <select id="filter-destino-partidas" aria-label="Filtrar por Destino" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>

      <label for="filter-pais-partidas">Filtrar por País:</label>
      <select id="filter-pais-partidas" aria-label="Filtrar por País" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>

      <label for="filter-tps-partidas">Filtrar por TPS:</label>
      <select id="filter-tps-partidas" aria-label="Filtrar por TPS" onchange="filtrar()">
        <option value="">Selecione</option>
      </select>
      <div id="partidasTabela" aria-live="polite" aria-relevant="all"></div>
    </section>

    <section class="tab-content" id="aba-novo" role="tabpanel" aria-labelledby="tab-novo" tabindex="0" aria-live="polite">
      <form id="formNovoVoo" novalidate>
        <label for="companhia">Companhia Aérea: <span aria-hidden="true" style="color:#ff4e50;">*</span></label>
        <input id="companhia" name="companhia" placeholder="Ex: AIR FRANCE" type="text" autocomplete="off" required aria-required="true"
          aria-describedby="erro-companhia" />
        <div id="erro-companhia" class="error-message" aria-live="assertive">Por favor, preencha a Companhia Aérea.</div>

        <label for="cidade">Cidade (Destino): <span aria-hidden="true" style="color:#ff4e50;">*</span></label>
        <input id="cidade" name="cidade" placeholder="Ex: Paris" type="text" autocomplete="off" required aria-required="true"
          aria-describedby="erro-cidade" />
        <div id="erro-cidade" class="error-message" aria-live="assertive">Por favor, preencha a Cidade.</div>

        <label for="icao">Código ICAO: <span aria-hidden="true" style="color:#ff4e50;">*</span></label>
        <input id="icao" name="icao" placeholder="Ex: LFPG" type="text" autocomplete="off" required aria-required="true" maxlength="4"
          aria-describedby="erro-icao" style="text-transform: uppercase;" />
        <div id="erro-icao" class="error-message" aria-live="assertive">Por favor, preencha um código ICAO válido (4 letras).</div>

        <label for="pais">País: <span aria-hidden="true" style="color:#ff4e50;">*</span></label>
        <input id="pais" name="pais" placeholder="Ex: France" type="text" autocomplete="off" required aria-required="true"
          aria-describedby="erro-pais" />
        <div id="erro-pais" class="error-message" aria-live="assertive">Por favor, preencha o País.</div>

        <label for="voo">Voo (Flight):</label>
        <input id="voo" name="voo" placeholder="Ex: 01234" type="text" autocomplete="off" aria-describedby="erro-voo" />

        <label for="horario">Horário (Time - HH:MM):</label>
        <input id="horario" name="horario" placeholder="Ex: 14:35" type="text" autocomplete="off" aria-describedby="erro-horario"
          pattern="^([01]?[0-9]|2[0-3]):[0-5][0-9]$" />
        <div id="erro-horario" class="error-message" aria-live="assertive">Formato inválido. Utilize HH:MM.</div>

        <label for="aeronave">Aeronave (A/C):</label>
        <input id="aeronave" name="aeronave" placeholder="Ex: A320" type="text" autocomplete="off" />

        <label for="status">Status:</label>
        <input id="status" name="status" placeholder="Ex: Confirmed" type="text" autocomplete="off" />

        <label for="tps">TPS:</label>
        <input id="tps" name="tps" placeholder="Ex: TPS1" type="text" autocomplete="off" />

        <label for="tipo">Tipo:</label>
        <select id="tipo" name="tipo" aria-label="Tipo de voo">
          <option value="chegada">Chegada</option>
          <option value="partida">Partida</option>
        </select>

        <button type="submit" id="btnAdicionarVoo" aria-live="polite" disabled>Adicionar</button>
        <div class="loading-indicator" id="loadingNovoVoo" aria-live="polite" role="status">Processando...</div>
      </form>
    </section>

    <section class="tab-content" id="aba-backup" role="tabpanel" aria-labelledby="tab-backup" tabindex="0" aria-live="polite">
      <button id="btnExportarBackup" aria-label="Exportar backup de voos">⬇️ Exportar Backup</button>
      <button id="btnImportarBackup" aria-label="Selecionar arquivo para importar backup">⬆️ Importar Backup</button>
      <input accept=".json" id="importar" aria-hidden="true" style="display:none" type="file" />
      <textarea id="output" placeholder="Exportação em formato texto" aria-label="Área de texto para exportação de dados" readonly></textarea>
      <div class="loading-indicator" id="loadingBackup" aria-live="polite" role="status">Processando...</div>
    </section>
  </main>

  <!-- Modal de confirmação -->
  <div id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="modalDesc">
    <div id="confirmModalContent">
      <h2 id="modalDesc" class="modal-title"></h2>
      <div class="button-container">
        <!-- Status buttons will be dynamically added here -->
      </div>
    </div>
  </div>

  <script>
    // Map English country names to emoji flags
    const bandeiras = {
      "afghanistan": "🇦🇫",
      "south africa": "🇿🇦",
      "albania": "🇦🇱",
      "germany": "🇩🇪",
      "andorra": "🇦🇩",
      "angola": "🇦🇴",
      "antigua and barbuda": "🇦🇬",
      "saudi arabia": "🇸🇦",
      "algeria": "🇩🇿",
      "argentina": "🇦🇷",
      "armenia": "🇦🇲",
      "australia": "🇦🇺",
      "austria": "🇦🇹",
      "azerbaijan": "🇦🇿",
      "the bahamas": "🇧🇸",
      "bahrain": "🇧🇭",
      "bangladesh": "🇧🇩",
      "barbados": "🇧🇧",
      "belgium": "🇧🇪",
      "belize": "🇧🇿",
      "benin": "🇧🇯",
      "belarus": "🇧🇾",
      "bolivia": "🇧🇴",
      "bosnia and herzegovina": "🇧🇦",
      "botswana": "🇧🇼",
      "brazil": "🇧🇷",
      "brunei": "🇧🇳",
      "bulgaria": "🇧🇬",
      "burkina faso": "🇧🇫",
      "burundi": "🇧🇮",
      "bhutan": "🇧🇹",
      "cape verde": "🇨🇻",
      "cambodia": "🇰🇭",
      "cameroon": "🇨🇲",
      "canada": "🇨🇦",
      "qatar": "🇶🇦",
      "kazakhstan": "🇰🇿",
      "chad": "🇹🇩",
      "chile": "🇨🇱",
      "china": "🇨🇳",
      "cyprus": "🇨🇾",
      "colombia": "🇨🇴",
      "comoros": "🇰🇲",
      "congo": "🇨🇬",
      "south korea": "🇰🇷",
      "north korea": "🇰🇵",
      "kosovo": "🇽🇰",
      "ivory coast": "🇨🇮",
      "costa rica": "🇨🇷",
      "croatia": "🇭🇷",
      "cuba": "🇨🇺",
      "denmark": "🇩🇰",
      "djibouti": "🇩🇯",
      "dominica": "🇩🇲",
      "egypt": "🇪🇬",
      "el salvador": "🇸🇻",
      "united arab emirates": "🇦🇪",
      "ecuador": "🇪🇨",
      "eritrea": "🇪🇷",
      "slovakia": "🇸🇰",
      "slovenia": "🇸🇮",
      "spain": "🇪🇸",
      "united states": "🇺🇸",
      "estonia": "🇪🇪",
      "ethiopia": "🇪🇹",
      "fiji": "🇫🇯",
      "philippines": "🇵🇭",
      "finland": "🇫🇮",
      "france": "🇫🇷",
      "gambia": "🇬🇲",
      "ghana": "🇬🇭",
      "georgia": "🇬🇪",
      "grenada": "🇬🇩",
      "greece": "🇬🇷",
      "guatemala": "🇬🇹",
      "guyana": "🇬🇾",
      "guinea": "🇬🇳",
      "guinea-bissau": "🇬🇼",
      "equatorial guinea": "🇬🇶",
      "haiti": "🇭🇹",
      "netherlands": "🇳🇱",
      "honduras": "🇭🇳",
      "hungary": "🇭🇺",
      "iraq": "🇮🇶",
      "iran": "🇮🇷",
      "ireland": "🇮🇪",
      "iceland": "🇮🇸",
      "israel": "🇮🇱",
      "italy": "🇮🇹",
      "jamaica": "🇯🇲",
      "japan": "🇯🇵",
      "jordan": "🇯🇴",
      "kiribati": "🇰🇮",
      "kuwait": "🇰🇼",
      "kyrgyzstan": "🇰🇬",
      "laos": "🇱🇦",
      "lesotho": "🇱🇸",
      "latvia": "🇱🇻",
      "lebanon": "🇱🇧",
      "liberia": "🇱🇷",
      "libya": "🇱🇾",
      "liechtenstein": "🇱🇮",
      "lithuania": "🇱🇹",
      "luxembourg": "🇱🇺",
      "madagascar": "🇲🇬",
      "malaysia": "🇲🇾",
      "malawi": "🇲🇼",
      "maldives": "🇲🇻",
      "mali": "🇲🇱",
      "malta": "🇲🇹",
      "morocco": "🇲🇦",
      "marshall islands": "🇲🇭",
      "mauritius": "🇲🇺",
      "mauritania": "🇲🇷",
      "mexico": "🇲🇽",
      "micronesia": "🇫🇲",
      "moldova": "🇲🇩",
      "monaco": "🇲🇨",
      "mongolia": "🇲🇳",
      "montenegro": "🇲🇪",
      "mozambique": "🇲🇿",
      "namibia": "🇳🇦",
      "nauru": "🇳🇷",
      "nepal": "🇳🇵",
      "nicaragua": "🇳🇮",
      "niger": "🇳🇪",
      "nigeria": "🇳🇬",
      "norway": "🇳🇴",
      "new zealand": "🇳🇿",
      "oman": "🇴🇲",
      "pakistan": "🇵🇰",
      "palau": "🇵🇼",
      "panama": "🇵🇦",
      "papua new guinea": "🇵🇬",
      "paraguay": "🇵🇾",
      "peru": "🇵🇪",
      "poland": "🇵🇱",
      "portugal": "🇵🇹",
      "romania": "🇷🇴",
      "rwanda": "🇷🇼",
      "russia": "🇷🇺",
      "samoa": "🇼🇸",
      "san marino": "🇸🇲",
      "saint kitts and nevis": "🇰🇳",
      "saint vincent and the grenadines": "🇻🇨",
      "saint lucia": "🇱🇨",
      "senegal": "🇸🇳",
      "serbia": "🇷🇸",
      "seychelles": "🇸🇨",
      "sierra leone": "🇸🇱",
      "singapore": "🇸🇬",
      "syria": "🇸🇾",
      "somalia": "🇸🇴",
      "sri lanka": "🇱🇰",
      "sweden": "🇸🇪",
      "switzerland": "🇨🇭",
      "sudan": "🇸🇩",
      "south sudan": "🇸🇸",
      "suriname": "🇸🇷",
      "thailand": "🇹🇭",
      "taiwan": "🇹🇼",
      "tanzania": "🇹🇿",
      "togo": "🇹🇬",
      "tonga": "🇹🇴",
      "trinidad and tobago": "🇹🇹",
      "tunisia": "🇹🇳",
      "turkmenistan": "🇹🇲",
      "turkey": "🇹🇷",
      "tuvalu": "🇹🇻",
      "ukraine": "🇺🇦",
      "uganda": "🇺🇬",
      "united kingdom": "🇬🇧",
      "united states": "🇺🇸",
      "uruguay": "🇺🇾",
      "uzbekistan": "🇺🇿",
      "vanuatu": "🇻🇺",
      "vatican city": "🇻🇦",
      "venezuela": "🇻🇪",
      "vietnam": "🇻🇳",
      "zambia": "🇿🇲",
      "zimbabwe": "🇿🇼"
    };

    let registrosChegadas = JSON.parse(localStorage.getItem('registrosChegadas')) || [];
    let registrosPartidas = JSON.parse(localStorage.getItem('registrosPartidas')) || [];

    let registrosFiltradosChegadas = registrosChegadas;
    let registrosFiltradosPartidas = registrosPartidas;

    const statusWorkflowChegadas = [
      "Scheduled",
      "Confirmed HH:MM",
      "Landing",
      "Landed",
      "Deplaining",
      "Finished",
      "Delayed",
      "Cancelled"
    ];

    const statusWorkflowPartidas = [
      "Scheduled",
      "Check-in Opened",
      "Boarding Gate XXX",
      "Boarding Now",
      "Last Call",
      "Taking Off",
      "Finished",
      "Delayed",
      "Cancelled"
    ];

    let confirmandoVoo = null;
    let confirmandoTipo = null;

    function formatHora(date) {
      let h = date.getHours();
      let m = date.getMinutes();
      return (h < 10 ? '0' + h : h) + ':' + (m < 10 ? '0' + m : m);
    }

    function trocarAba(indice) {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      // First, remove active state from all tabs and contents
      tabs.forEach(tab => {
        tab.classList.remove('active');
        tab.setAttribute('aria-selected', 'false');
        tab.tabIndex = -1;
      });
      tabContents.forEach(content => {
        content.classList.remove('active');
      });
      
      // Then set active state for selected tab and content
      const selectedTab = tabs[indice];
      const selectedContent = tabContents[indice];
      
      if (selectedTab && selectedContent) {
        selectedTab.classList.add('active');
        selectedTab.setAttribute('aria-selected', 'true');
        selectedTab.tabIndex = 0;
        selectedContent.classList.add('active');
        selectedContent.focus();
      }
      
      // Update selects and filter the data
      popularSelects();
      filtrar();
    }

    function handleKey(event, idx) {
      const tabs = Array.from(document.querySelectorAll('.tab'));
      let nextIndex = idx;

      switch (event.key) {
        case 'ArrowRight':
        case 'ArrowDown':
          nextIndex = (idx + 1) % tabs.length;
          break;
        case 'ArrowLeft':
        case 'ArrowUp':
          nextIndex = (idx - 1 + tabs.length) % tabs.length;
          break;
        case 'Home':
          nextIndex = 0;
          break;
        case 'End':
          nextIndex = tabs.length - 1;
          break;
        case 'Enter':
        case ' ':
          trocarAba(idx);
          event.preventDefault();
          return;
        default:
          return;
      }

      tabs[nextIndex].focus();
      trocarAba(nextIndex);
      event.preventDefault();
    }

    function normalizarNome(nome) {
      return nome.toLowerCase().replace(/[^a-z0-9]/g, "_");
    }

    function sanitizeHTML(str) {
      if (!str) return '';
      return str.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function popularSelects() {
      const selectIds = [
        'filter-companhia', 'filter-destino', 'filter-pais', 'filter-tps',
        'filter-companhia-partidas', 'filter-destino-partidas', 'filter-pais-partidas', 'filter-tps-partidas'
      ];
      selectIds.forEach(id => {
        const select = document.getElementById(id);
        while (select && select.options.length > 1) {
          select.removeChild(select.lastChild);
        }
      });

      const companhias = [...new Set([...registrosChegadas, ...registrosPartidas].map(voo => voo.companhia))].sort();
      const destinos = [...new Set([...registrosChegadas, ...registrosPartidas].map(voo => voo.cidade))].sort();
      const paises = [...new Set([...registrosChegadas, ...registrosPartidas].map(voo => voo.pais))].sort();
      const tps = [...new Set([...registrosChegadas, ...registrosPartidas].map(voo => voo.tps))].sort();

      const updateSelectOptions = (selectId, options) => {
        const select = document.getElementById(selectId);
        if (!select) return;
        options.forEach(option => {
          const optionElement = document.createElement('option');
          optionElement.value = option;
          optionElement.textContent = option;
          select.appendChild(optionElement);
        });
      };

      updateSelectOptions('filter-companhia', [''].concat(companhias));
      updateSelectOptions('filter-destino', [''].concat(destinos));
      updateSelectOptions('filter-pais', [''].concat(paises));
      updateSelectOptions('filter-tps', [''].concat(tps));

      updateSelectOptions('filter-companhia-partidas', [''].concat(companhias));
      updateSelectOptions('filter-destino-partidas', [''].concat(destinos));
      updateSelectOptions('filter-pais-partidas', [''].concat(paises));
      updateSelectOptions('filter-tps-partidas', [''].concat(tps));
    }

    function filtrar() {
      try {
        // Get filter values for arrivals
        const filtroCompanhia = document.getElementById('filter-companhia').value.toLowerCase();
        const filtroDestino = document.getElementById('filter-destino').value.toLowerCase();
        const filtroPais = document.getElementById('filter-pais').value.toLowerCase();
        const filtroTps = document.getElementById('filter-tps').value.toLowerCase();

        // Get filter values for departures
        const filtroCompanhiaP = document.getElementById('filter-companhia-partidas').value.toLowerCase();
        const filtroDestinoP = document.getElementById('filter-destino-partidas').value.toLowerCase();
        const filtroPaisP = document.getElementById('filter-pais-partidas').value.toLowerCase();
        const filtroTpsP = document.getElementById('filter-tps-partidas').value.toLowerCase();

        // Filter and sort arrivals
        registrosFiltradosChegadas = registrosChegadas
          .filter(voo => {
            if (!voo) return false;
            return (
              (filtroCompanhia === '' || (voo.companhia && voo.companhia.toLowerCase().includes(filtroCompanhia))) &&
              (filtroDestino === '' || (voo.cidade && voo.cidade.toLowerCase().includes(filtroDestino))) &&
              (filtroPais === '' || (voo.pais && voo.pais.toLowerCase().includes(filtroPais))) &&
              (filtroTps === '' || (voo.tps && voo.tps.toLowerCase().includes(filtroTps)))
            );
          })
          .sort((a, b) => {
            // First sort by time
            const timeA = a.horario || '00:00';
            const timeB = b.horario || '00:00';
            const timeDiff = timeA.localeCompare(timeB);
            if (timeDiff !== 0) return timeDiff;

            // Then by company
            const companyDiff = (a.companhia || '').localeCompare(b.companhia || '');
            if (companyDiff !== 0) return companyDiff;

            // Finally by flight number
            return (a.voo || '').localeCompare(b.voo || '');
          });

        // Filter and sort departures
        registrosFiltradosPartidas = registrosPartidas
          .filter(voo => {
            if (!voo) return false;
            return (
              (filtroCompanhiaP === '' || (voo.companhia && voo.companhia.toLowerCase().includes(filtroCompanhiaP))) &&
              (filtroDestinoP === '' || (voo.cidade && voo.cidade.toLowerCase().includes(filtroDestinoP))) &&
              (filtroPaisP === '' || (voo.pais && voo.pais.toLowerCase().includes(filtroPaisP))) &&
              (filtroTpsP === '' || (voo.tps && voo.tps.toLowerCase().includes(filtroTpsP)))
            );
          })
          .sort((a, b) => {
            // First sort by time
            const timeA = a.horario || '00:00';
            const timeB = b.horario || '00:00';
            const timeDiff = timeA.localeCompare(timeB);
            if (timeDiff !== 0) return timeDiff;

            // Then by company
            const companyDiff = (a.companhia || '').localeCompare(b.companhia || '');
            if (companyDiff !== 0) return companyDiff;

            // Finally by flight number
            return (a.voo || '').localeCompare(b.voo || '');
          });

        // Update tables
        renderTabela(registrosFiltradosChegadas, 'chegadasTabela');
        renderTabela(registrosFiltradosPartidas, 'partidasTabela');

      } catch (error) {
        console.error('Erro ao filtrar voos:', error);
        alert('Erro ao filtrar voos. Por favor, tente novamente.');
      }
    }

    function confirmRemoverVoo(indice, tipo) {
      try {
        let voo = null;
        let registrosFiltrados = null;
        let registrosOriginais = null;

        // Determine which array to use based on type
        if (tipo === 'chegadasTabela') {
          registrosFiltrados = registrosFiltradosChegadas;
          registrosOriginais = registrosChegadas;
        } else if (tipo === 'partidasTabela') {
          registrosFiltrados = registrosFiltradosPartidas;
          registrosOriginais = registrosPartidas;
        } else {
          throw new Error('Tipo de tabela inválido');
        }

        // Get the flight to remove
        voo = registrosFiltrados[indice];
        if (!voo) {
          throw new Error('Voo não encontrado');
        }

        // Show confirmation dialog with flight details
        const message = `Tem certeza que deseja remover este voo?\n\n` +
                       `Companhia: ${voo.companhia}\n` +
                       `Voo: ${voo.voo || '(sem código)'}\n` +
                       `Destino: ${voo.cidade}\n` +
                       `Horário: ${voo.horario || '(não definido)'}\n` +
                       `Status: ${voo.status || 'Scheduled'}`;

        if (confirm(message)) {
          removerVoo(indice, tipo);
        }
      } catch (error) {
        console.error('Erro ao confirmar remoção:', error);
        alert('Erro ao tentar remover o voo: ' + (error.message || 'erro desconhecido'));
      }
    }

    function removerVoo(indice, tipo) {
      try {
        let registrosFiltrados = null;
        let registrosOriginais = null;

        // Determine which array to use
        if (tipo === 'chegadasTabela') {
          registrosFiltrados = registrosFiltradosChegadas;
          registrosOriginais = registrosChegadas;
        } else {
          registrosFiltrados = registrosFiltradosPartidas;
          registrosOriginais = registrosPartidas;
        }

        // Get the flight to remove
        const vooParaRemover = registrosFiltrados[indice];
        if (!vooParaRemover) {
          throw new Error('Voo não encontrado');
        }

        // Find and remove from original array
        const globalIndex = registrosOriginais.findIndex(v => 
          v.companhia === vooParaRemover.companhia &&
          v.cidade === vooParaRemover.cidade &&
          v.horario === vooParaRemover.horario &&
          v.voo === vooParaRemover.voo
        );

        if (globalIndex > -1) {
          registrosOriginais.splice(globalIndex, 1);
          if (salvarDados()) {
            alert('Voo removido com sucesso!');
          }
        } else {
          throw new Error('Voo não encontrado na lista original');
        }

      } catch (error) {
        console.error('Erro ao remover voo:', error);
        alert('Erro ao remover o voo: ' + (error.message || 'erro desconhecido'));
      }
    }

    function adicionarVoo(event) {
      event.preventDefault();
      
      // Show loading indicator
      const loadingNovoVoo = document.getElementById('loadingNovoVoo');
      if (loadingNovoVoo) loadingNovoVoo.style.display = 'block';

      try {
        // Get form values
        const companhia = document.getElementById("companhia").value.trim();
        const cidade = document.getElementById("cidade").value.trim();
        const icao = document.getElementById("icao").value.trim().toUpperCase();
        const pais = document.getElementById("pais").value.trim();
        const voo = document.getElementById("voo").value.trim();
        const horario = document.getElementById("horario").value.trim();
        const aeronave = document.getElementById("aeronave").value.trim();
        const status = document.getElementById("status").value.trim() || "Scheduled";
        const tps = document.getElementById("tps").value.trim();
        const tipo = document.getElementById("tipo").value;

        // Validate required fields
        if (!companhia || !cidade || !icao || !pais) {
          throw new Error('Por favor, preencha todos os campos obrigatórios.');
        }

        // Validate ICAO code format
        if (!/^[A-Z]{4}$/.test(icao)) {
          throw new Error('Código ICAO inválido. Deve conter 4 letras.');
        }

        // Validate time format if provided
        if (horario && !/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(horario)) {
          throw new Error('Formato de horário inválido. Use HH:MM.');
        }

        const novoRegistro = {
          companhia,
          cidade,
          icao,
          pais,
          voo,
          horario,
          aeronave,
          status,
          tps,
          horarioConfirmado: null,
          frequencia: 1,
          dataCadastro: new Date().toISOString()
        };

        const registros = tipo === "chegada" ? registrosChegadas : registrosPartidas;

        // Check for duplicate flights
        if (registros.some(e => 
          e.companhia === companhia && 
          e.cidade === cidade && 
          e.icao === icao &&
          e.horario === horario)) {
          throw new Error('Este voo já está cadastrado.');
        }

        // Add new flight
        registros.push(novoRegistro);

        // Save data and update UI
        if (salvarDados()) {
          document.getElementById("formNovoVoo").reset();
          document.getElementById("btnAdicionarVoo").setAttribute('disabled', 'disabled');
          trocarAba(tipo === "chegada" ? 0 : 1);
          alert("Voo adicionado com sucesso!");
        }

      } catch (error) {
        console.error('Erro ao adicionar voo:', error);
        alert(error.message || 'Erro ao adicionar voo.');
      } finally {
        // Hide loading indicator
        if (loadingNovoVoo) loadingNovoVoo.style.display = 'none';
      }
    }

    function salvarDados() {
      try {
        // Validate data before saving
        if (!Array.isArray(registrosChegadas) || !Array.isArray(registrosPartidas)) {
          throw new Error('Dados inválidos: registros devem ser arrays');
        }

        // Clean up any undefined or null entries
        registrosChegadas = registrosChegadas.filter(Boolean);
        registrosPartidas = registrosPartidas.filter(Boolean);

        // Save to localStorage
        localStorage.setItem('registrosChegadas', JSON.stringify(registrosChegadas));
        localStorage.setItem('registrosPartidas', JSON.stringify(registrosPartidas));

        // Update filtered data
        registrosFiltradosChegadas = [...registrosChegadas];
        registrosFiltradosPartidas = [...registrosPartidas];

        // Update UI
        popularSelects();
        atualizarTabelas();

        return true;
      } catch (error) {
        console.error('Erro ao salvar dados:', error);
        alert('Erro ao salvar dados. Por favor, tente novamente.');
        return false;
      }
    }

    function atualizarTabelas() {
      filtrar();
    }

    function renderTabela(registros, destinoId) {
      registros.forEach(voo => {
        if (voo.horario && voo.horario.length < 5 && voo.horario.includes(':')) {
          voo.horario = voo.horario.padStart(5, '0');
        }
      });

      registros.sort((a, b) => {
        const [aHour, aMinute] = (a.horario || "00:00").split(':').map(Number);
        const [bHour, bMinute] = (b.horario || "00:00").split(':').map(Number);
        if (aHour !== bHour) return aHour - bHour;
        return aMinute - bMinute;
      });

      let html = '<table><thead><tr>' +
        '<th aria-label="Logo da Companhia">AIRLINES</th><th>FLIGHT</th><th>DESTINATION</th><th>ICAO</th>' +
        '<th>COUNTRY</th><th>TIME</th><th>A/C</th><th>TPS</th><th>STATUS</th><th>ACTION</th>' +
        '</tr></thead><tbody>';

      registros.forEach((e, i) => {
        const logo = '<td class="logo-cell"><img class="logo" src="logos/' + normalizarNome(e.companhia) + '.png" alt="Logo da companhia ' + e.companhia + '" onerror="this.src=\'logos/default.png\'" title="' + e.companhia + '"></td>';

        const paisNormalized = e.pais ? e.pais.toLowerCase().trim() : "";
        const flag = bandeiras[paisNormalized] || "";
        const paisFlagHtml = flag
          ? '<span role="img" aria-label="' + sanitizeHTML(e.pais) + '" title="' + sanitizeHTML(e.pais) + '" style="font-size: 1.4em; user-select:none;">' + flag + '</span>'
          : sanitizeHTML(e.pais || "");

        let statusExibido = e.status || "";

        if (statusExibido === "Confirmed HH:MM" && e.horarioConfirmado) {
          statusExibido = "Confirmed " + e.horarioConfirmado;
        } else if (statusExibido.toLowerCase() === "estimated") {
          statusExibido = "Scheduled";
        }

        const statusClass = e.piscante ? e.piscante + '-piscante' : "";

        html += '<tr>' +
          logo +
          '<td>' + sanitizeHTML(e.voo || '') + '</td>' +
          '<td>' + sanitizeHTML(e.cidade) + '</td>' +
          '<td>' + sanitizeHTML(e.icao) + '</td>' +
          '<td>' + paisFlagHtml + '</td>' +
          '<td>' + sanitizeHTML(e.horario || '') + '</td>' +
          '<td>' + sanitizeHTML(e.aeronave || '') + '</td>' +
          '<td>' + sanitizeHTML(e.tps || '') + '</td>' +
          '<td class="' + statusClass + ' status-cell" tabindex="0" role="button" aria-label="Alterar status do voo ' + (e.voo || '') + '" data-status="' + statusExibido + '" data-voo=\'' + encodeURIComponent(JSON.stringify(e)) + '\' data-tipo="' + destinoId + '" onclick="showConfirmModal(JSON.parse(decodeURIComponent(this.dataset.voo)), this.dataset.tipo)" onkeypress="if(event.key === \'Enter\' || event.key === \' \') { event.preventDefault(); this.click(); }">' +
          '<span class="status-text">' + sanitizeHTML(statusExibido) + '</span>' +
          (e.horarioConfirmado ? '<span class="confirmed-time">' + sanitizeHTML(formatarHorarioStatus(e.horarioConfirmado, e.status)) + '</span>' : '') +
          '</td>' +
          '<td><button class="remove-btn" aria-label="Remover voo ' + (e.voo || '') + ' para ' + e.cidade + '" onclick="confirmRemoverVoo(' + i + ', \'' + destinoId + '\')">✖</button></td>' +
          '</tr>';
      });

      html += '</tbody></table>';
      document.getElementById(destinoId).innerHTML = html;
    }

    // Auto-update status based on time
    function atualizarStatusAutomatico() {
      const agora = new Date();
      
      // Update arrivals
      registrosChegadas.forEach(voo => {
        if (!voo.horario || voo.status === 'Cancelled') return;
        
        const [horaVoo, minutoVoo] = voo.horario.split(':').map(Number);
        const horaAtual = agora.getHours();
        const minutoAtual = agora.getMinutes();
        
        const minutosPassados = (horaAtual * 60 + minutoAtual) - (horaVoo * 60 + minutoVoo);
        
        // Resetar status se o voo ainda não aconteceu
        if (minutosPassados < 0) {
          if (voo.status !== 'Delayed' && voo.status !== 'Cancelled') {
            voo.status = 'Scheduled';
            voo.piscante = null;
          }
        }
        // Atualizar status apenas se o horário já passou
        else if (minutosPassados >= 30 && voo.status !== 'Finished') {
          voo.status = 'Finished';
          voo.piscante = null;
          voo.horarioConfirmado = formatHora(agora);
        } else if (minutosPassados >= 5 && voo.status !== 'Landed' && voo.status !== 'Finished') {
          voo.status = 'Landed';
          voo.piscante = null;
          voo.horarioConfirmado = formatHora(agora);
        } else if (minutosPassados >= 0 && voo.status === 'Scheduled') {
          voo.status = 'Landing';
          voo.piscante = 'green';
          voo.horarioConfirmado = formatHora(agora);
        }
      });

      // Update departures
      registrosPartidas.forEach(voo => {
        if (!voo.horario || voo.status === 'Cancelled') return;
        
        const [horaVoo, minutoVoo] = voo.horario.split(':').map(Number);
        const horaAtual = agora.getHours();
        const minutoAtual = agora.getMinutes();
        
        const minutosAte = (horaVoo * 60 + minutoVoo) - (horaAtual * 60 + minutoAtual);
        
        // Resetar status se falta mais de 30 minutos
        if (minutosAte > 30) {
          if (voo.status !== 'Delayed' && voo.status !== 'Cancelled') {
            voo.status = 'Scheduled';
            voo.piscante = null;
          }
        }
        // Atualizar status baseado no tempo até a partida
        else if (minutosAte <= -30 && voo.status !== 'Finished') {
          voo.status = 'Finished';
          voo.piscante = null;
          voo.horarioConfirmado = formatHora(agora);
        } else if (minutosAte <= 0 && voo.status === 'Boarding Now') {
          voo.status = 'Taking Off';
          voo.piscante = 'green';
          voo.horarioConfirmado = formatHora(agora);
        } else if (minutosAte <= 30 && voo.status === 'Scheduled') {
          voo.status = 'Boarding Now';
          voo.piscante = 'green';
          voo.horarioConfirmado = formatHora(agora);
        }
      });

      // Salvar alterações e atualizar interface
      salvarDados();
      
      // Atualizar o título da página e relógio com o horário atual
      const horaFormatada = formatHora(agora);
      document.title = `New Dubai International Airport - ${horaFormatada}`;
      document.getElementById('clock').textContent = horaFormatada;
    }

    // Atualizar o relógio a cada segundo
    setInterval(() => {
      const agora = new Date();
      document.getElementById('clock').textContent = formatHora(agora);
    }, 1000);

    // Garantir que a página seja atualizada se ficar em background
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        sincronizarStatusInicial();
      }
    });

    window.onload = () => {
      popularSelects();
      atualizarTabelas();
      initFormListeners();

      document.getElementById('btnExportarBackup').addEventListener('click', exportarBackup);
      document.getElementById('btnImportarBackup').addEventListener('click', () => {
        document.getElementById('importar').click();
      });
      document.getElementById('importar').addEventListener('change', importarBackup);

      // Sincronizar status imediatamente ao carregar
      sincronizarStatusInicial();
      
      // Configurar atualizações automáticas mais frequentes
      setInterval(atualizarStatusAutomatico, 30000); // Atualizar a cada 30 segundos
    };

    function sincronizarStatusInicial() {
      const agora = new Date();
      
      // Sincronizar chegadas
      registrosChegadas.forEach(voo => {
        if (!voo.horario || voo.status === 'Cancelled') return;
        
        const [horaVoo, minutoVoo] = voo.horario.split(':').map(Number);
        const horaAtual = agora.getHours();
        const minutoAtual = agora.getMinutes();
        
        const minutosPassados = (horaAtual * 60 + minutoAtual) - (horaVoo * 60 + minutoVoo);
        
        // Resetar status se o voo ainda não aconteceu
        if (minutosPassados < 0) {
          if (voo.status !== 'Delayed' && voo.status !== 'Cancelled') {
            voo.status = 'Scheduled';
            voo.piscante = null;
          }
        }
        // Atualizar status apenas se o horário já passou
        else if (minutosPassados >= 30) {
          voo.status = 'Finished';
          voo.piscante = null;
        } else if (minutosPassados >= 5) {
          voo.status = 'Landed';
          voo.piscante = null;
        } else if (minutosPassados >= 0) {
          voo.status = 'Landing';
          voo.piscante = 'green';
        }
      });
      
      // Sincronizar partidas
      registrosPartidas.forEach(voo => {
        if (!voo.horario || voo.status === 'Cancelled') return;
        
        const [horaVoo, minutoVoo] = voo.horario.split(':').map(Number);
        const horaAtual = agora.getHours();
        const minutoAtual = agora.getMinutes();
        
        const minutosAte = (horaVoo * 60 + minutoVoo) - (horaAtual * 60 + minutoAtual);
        
        // Resetar status se falta mais de 30 minutos
        if (minutosAte > 30) {
          if (voo.status !== 'Delayed' && voo.status !== 'Cancelled') {
            voo.status = 'Scheduled';
            voo.piscante = null;
          }
        }
        // Atualizar status baseado no tempo até a partida
        else if (minutosAte <= -30) {
          voo.status = 'Finished';
          voo.piscante = null;
        } else if (minutosAte <= 0) {
          voo.status = 'Taking Off';
          voo.piscante = 'green';
        } else if (minutosAte <= 30) {
          voo.status = 'Boarding Now';
          voo.piscante = 'green';
        }
      });
      
      // Salvar alterações e atualizar interface
      salvarDados();
    }

    function initFormListeners() {
      const form = document.getElementById('formNovoVoo');
      const horarioInput = document.getElementById('horario');
      
      // Add submit handler
      form.addEventListener('submit', adicionarVoo);

      // Add input handlers for required fields
      const camposObrigatorios = ['companhia', 'cidade', 'icao', 'pais'];
      camposObrigatorios.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          ['input', 'blur'].forEach(eventType => {
            campo.addEventListener(eventType, validarForm);
          });
        }
      });

      // Add special handler for time input
      if (horarioInput) {
        ['input', 'blur'].forEach(eventType => {
          horarioInput.addEventListener(eventType, validarForm);
        });
      }

      // Clear error messages when form is reset
      form.addEventListener('reset', () => {
        document.querySelectorAll('.error-message').forEach(error => {
          error.style.display = 'none';
        });
        document.querySelectorAll('.invalid').forEach(field => {
          field.classList.remove('invalid');
        });
      });

      function validarForm() {
        let valido = true;
        camposObrigatorios.forEach(id => {
          const el = document.getElementById(id);
          const errorEl = document.getElementById('erro-' + id);
          
          if (!el.value.trim()) {
            valido = false;
            el.classList.add('invalid');
            if (errorEl) {
              errorEl.style.display = 'block';
            }
          } else {
            el.classList.remove('invalid');
            if (errorEl) {
              errorEl.style.display = 'none';
            }
          }
          
          // Special validation for ICAO code
          if (id === 'icao') {
            const icaoValue = el.value.trim();
            if (icaoValue && !/^[A-Z]{4}$/.test(icaoValue.toUpperCase())) {
              valido = false;
              el.classList.add('invalid');
              if (errorEl) {
                errorEl.style.display = 'block';
              }
            }
          }
        });

        // Validate time format if provided
        const horarioEl = document.getElementById('horario');
        const horarioErrorEl = document.getElementById('erro-horario');
        if (horarioEl && horarioEl.value.trim()) {
          const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
          if (!timeRegex.test(horarioEl.value.trim())) {
            valido = false;
            horarioEl.classList.add('invalid');
            if (horarioErrorEl) {
              horarioErrorEl.style.display = 'block';
            }
          } else {
            horarioEl.classList.remove('invalid');
            if (horarioErrorEl) {
              horarioErrorEl.style.display = 'none';
            }
          }
        }

        const btn = document.getElementById('btnAdicionarVoo');
        if (valido) {
          btn.removeAttribute('disabled');
        } else {
          btn.setAttribute('disabled', 'disabled');
        }
      }
      validarForm();
    }

    function exportarBackup() {
      try {
        // Show loading indicator
        const loadingBackup = document.getElementById('loadingBackup');
        if (loadingBackup) loadingBackup.style.display = 'block';

        // Validate data before export
        if (!Array.isArray(registrosChegadas) || !Array.isArray(registrosPartidas)) {
          throw new Error('Dados inválidos para exportação');
        }

        // Clean up any undefined or null entries
        const chegadasLimpo = registrosChegadas.filter(Boolean);
        const partidasLimpo = registrosPartidas.filter(Boolean);

        const dadosExport = {
          chegadas: chegadasLimpo,
          partidas: partidasLimpo,
          dataExport: new Date().toISOString(),
          versao: '1.0'
        };

        // Format JSON with indentation for better readability
        const jsonStr = JSON.stringify(dadosExport, null, 2);
        const outputArea = document.getElementById('output');
        
        if (outputArea) {
          outputArea.value = jsonStr;
          outputArea.select();
          
          // Try to copy to clipboard
          try {
            document.execCommand('copy');
            alert('Backup exportado e copiado para a área de transferência!');
          } catch (clipboardError) {
            console.warn('Não foi possível copiar para a área de transferência:', clipboardError);
            alert('Backup exportado com sucesso!');
          }
        }

      } catch (error) {
        console.error('Erro ao exportar backup:', error);
        alert('Erro ao exportar backup: ' + (error.message || 'erro desconhecido'));
      } finally {
        // Hide loading indicator
        const loadingBackup = document.getElementById('loadingBackup');
        if (loadingBackup) loadingBackup.style.display = 'none';
      }
    }

    // Modal handling functions
    function showConfirmModal(voo, tipo) {
      const modal = document.getElementById('confirmModal');
      const modalDesc = document.getElementById('modalDesc');
      const modalContent = document.getElementById('confirmModalContent');
      
      confirmandoVoo = voo;
      confirmandoTipo = tipo;
      
      // Store the element that had focus before opening modal
      modal.dataset.previousFocus = document.activeElement.id || '';
      
      // Update modal description
      modalDesc.textContent = `Voo ${voo.voo || '(sem código)'} para ${voo.cidade}`;
      
      // Clear existing buttons
      const buttonContainer = modalContent.querySelector('.button-container') || document.createElement('div');
      buttonContainer.className = 'button-container';
      buttonContainer.innerHTML = '';
      
      // Define available status options based on current status and flight type
      const statusOptions = [];
      const currentTime = new Date();
      const flightTime = voo.horario ? new Date(currentTime.toDateString() + ' ' + voo.horario) : null;
      
      if (voo.status !== 'Cancelled' && voo.status !== 'Finished') {
        if (tipo === 'chegadasTabela') {
          // Arrival status options
          statusOptions.push(
            { status: 'Confirmed', label: 'Confirm Arrival', color: '#4CAF50' },
            { status: 'Landing', label: 'Landing', color: '#2196F3' }
          );
        } else {
          // Departure status options
          statusOptions.push(
            { status: 'Boarding Now', label: 'Start Boarding', color: '#2196F3' },
            { status: 'Taking Off', label: 'Taking Off', color: '#4CAF50' }
          );
        }
        
        // Common status options
        statusOptions.push(
          { status: 'Delayed', label: 'Mark Delayed', color: '#ff9800' },
          { status: 'Cancelled', label: 'Cancel Flight', color: '#f44336' }
        );
      }
      
      if (voo.status === 'Delayed' || voo.status === 'Boarding Now') {
        statusOptions.push({ status: 'Scheduled', label: 'Reset to Scheduled', color: '#757575' });
      }
      
      // Create buttons for each status option
      statusOptions.forEach(option => {
        const button = document.createElement('button');
        button.textContent = option.label;
        button.style.backgroundColor = option.color;
        button.onclick = () => updateStatus(option.status);
        buttonContainer.appendChild(button);
      });
      
      // Add close button
      const closeButton = document.createElement('button');
      closeButton.textContent = 'Close';
      closeButton.className = 'close-button';
      closeButton.onclick = hideConfirmModal;
      buttonContainer.appendChild(closeButton);
      
      // Update modal content
      modalContent.appendChild(buttonContainer);
      modal.style.display = 'block';
      
      // Focus first button
      const firstButton = buttonContainer.querySelector('button');
      if (firstButton) firstButton.focus();
      
      // Close modal when clicking outside
      modal.onclick = function(event) {
        if (event.target === modal) {
          hideConfirmModal();
        }
      };
      
      // Add keyboard support
      document.addEventListener('keydown', handleModalKeyboard);
    }
    
    function hideConfirmModal() {
      const modal = document.getElementById('confirmModal');
      modal.style.display = 'none';
      
      // Restore focus to previous element
      if (modal.dataset.previousFocus) {
        const previousElement = document.getElementById(modal.dataset.previousFocus);
        if (previousElement) {
          previousElement.focus();
        }
      }
      
      confirmandoVoo = null;
      confirmandoTipo = null;
      document.removeEventListener('keydown', handleModalKeyboard);
    }
    
    function handleModalKeyboard(event) {
      const modal = document.getElementById('confirmModal');
      const focusableElements = modal.querySelectorAll('button');
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];
      
      switch (event.key) {
        case 'Escape':
          hideConfirmModal();
          break;
        case 'Tab':
          if (event.shiftKey && document.activeElement === firstFocusable) {
            event.preventDefault();
            lastFocusable.focus();
          } else if (!event.shiftKey && document.activeElement === lastFocusable) {
            event.preventDefault();
            firstFocusable.focus();
          }
          break;
      }
    }
    function updateStatus(newStatus) {
      if (confirmandoVoo && confirmandoTipo) {
        const now = new Date();
        confirmandoVoo.status = newStatus;
        confirmandoVoo.horarioConfirmado = formatHora(now);
        confirmandoVoo.ultimaAtualizacao = now.toISOString();

        switch (newStatus) {
          case 'Delayed':
            confirmandoVoo.piscante = 'red';
            break;
          case 'Confirmed':
            confirmandoVoo.piscante = 'green';
            break;
          case 'Cancelled':
            confirmandoVoo.piscante = null;
            break;
          case 'Boarding Now':
            confirmandoVoo.piscante = 'green';
            break;
          case 'Taking Off':
          case 'Landing':
            confirmandoVoo.piscante = 'green';
            break;
          case 'Finished':
            confirmandoVoo.piscante = null;
            break;
          default:
            confirmandoVoo.piscante = null;
        }
        
        if (salvarDados()) {
          hideConfirmModal();
        }
      }
    }

    function formatHora(data) {
      if (typeof data === 'string') {
        // If it's already in HH:MM format, return as is
        if (/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/.test(data)) {
          return data;
        }
        // Try to parse the string as a date
        data = new Date(data);
      }
      
      if (!(data instanceof Date) || isNaN(data)) {
        console.error('Invalid date provided to formatHora:', data);
        return '';
      }

      return String(data.getHours()).padStart(2, '0') + ':' + String(data.getMinutes()).padStart(2, '0');
    }

    function formatarHorarioStatus(horario, status) {
      if (!horario) return '';
      
      const formattedTime = formatHora(horario);
      switch (status) {
        case 'Delayed':
          return 'Delayed from ' + formattedTime;
        case 'Confirmed':
          return 'Confirmed at ' + formattedTime;
        case 'Cancelled':
          return 'Cancelled at ' + formattedTime;
        default:
          return formattedTime;
      }
    }

    function importarBackup(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Show loading indicator
      const loadingBackup = document.getElementById('loadingBackup');
      if (loadingBackup) loadingBackup.style.display = 'block';

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const dadosImport = JSON.parse(e.target.result);
          
          // Validate backup data structure
          if (!dadosImport || typeof dadosImport !== 'object') {
            throw new Error('Formato de backup inválido');
          }

          // Validate and import arrivals
          if ('chegadas' in dadosImport) {
            if (!Array.isArray(dadosImport.chegadas)) {
              throw new Error('Dados de chegadas inválidos');
            }
            registrosChegadas = dadosImport.chegadas.filter(voo => 
              voo && typeof voo === 'object' && 
              typeof voo.companhia === 'string' &&
              typeof voo.cidade === 'string'
            );
          }

          // Validate and import departures
          if ('partidas' in dadosImport) {
            if (!Array.isArray(dadosImport.partidas)) {
              throw new Error('Dados de partidas inválidos');
            }
            registrosPartidas = dadosImport.partidas.filter(voo => 
              voo && typeof voo === 'object' && 
              typeof voo.companhia === 'string' &&
              typeof voo.cidade === 'string'
            );
          }

          // Save and update UI
          if (salvarDados()) {
            alert('Backup importado com sucesso!');
          }
        } catch (error) {
          console.error('Erro ao importar backup:', error);
          alert('Erro ao importar backup: ' + (error.message || 'arquivo inválido'));
        } finally {
          // Hide loading indicator
          if (loadingBackup) loadingBackup.style.display = 'none';
          // Reset file input
          event.target.value = '';
        }
      };

      reader.onerror = function() {
        console.error('Erro ao ler arquivo');
        alert('Erro ao ler arquivo de backup');
        if (loadingBackup) loadingBackup.style.display = 'none';
        event.target.value = '';
      };

      reader.readAsText(file);
    }
  </script>
  <script src="init.js"></script>
</body>

</html>

